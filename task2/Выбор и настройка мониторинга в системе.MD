# Выбор и настройка мониторинга в системе «Александрит»

## 1. Мотивация

На текущий момент система для бизнеса является «черным ящиком». Мы узнаем о проблемах только тогда, когда клиенты начинают уходить, а операторы жаловаться. Внедрение мониторинга даст компании следующие преимущества:

*   **Сокращение финансовых потерь:** Мы сможем в реальном времени видеть «зависшие» заказы и предотвращать разрыв контрактов с API-партнерами.
*   **Прозрачность для бизнеса:** Возможность точно отвечать на вопрос «почему заказ задерживается» и давать клиентам реалистичные прогнозы по срокам.
*   **Оптимизация ресурсов:** Мы поймем, где именно находится узкое горлышко (в расчетах MES, в очереди RabbitMQ или в базе данных), и сможем точечно инвестировать в инфраструктуру.
*   **Снижение нагрузки на команду:** Автоматические алерты позволят находить ошибки до того, как они станут массовыми, избавляя разработчиков от «пожарного» режима работы.

## 2. Выбор подхода к мониторингу

Для охвата всех уровней системы мы будем использовать гибридный подход:

*   **Четыре золотых сигнала (Four Golden Signals):** Для внешних и внутренних API (Shop, CRM, MES). Это позволит следить за пользовательским опытом.
*   **USE (Utilization, Saturation, Errors):** Для инфраструктуры (EC2-инстансы, PostgreSQL, RabbitMQ). Поможет выявить аппаратные ограничения и нехватку ресурсов.

## 3. Метрики для отслеживания

| Метрика | Зачем нужна | Ярлыки (Labels) |
| :--- | :--- | :--- |
| **API Request Rate by Client** (RPS per User) |  Позволит выявить API-партнеров, создающих аномальную нагрузку . Необходима для настройки Rate Limiting. | `client_id` (или `api_key`), `endpoint`, `status_code` |
| **RabbitMQ Dead Letter Queue Depth** |  Количество сообщений, которые не удалось обработать (ошибки валидации, сбои).  | `queue_name`, `vhost` |
| **RabbitMQ Unacknowledged Messages** |  «Сообщения в полете». Показывает, сколько заказов сейчас находится в работе у воркеров MES.  | `queue_name` |
| **Database Lock Wait Time** |  Время ожидания блокировок в БД. Критично для диагностики тормозов дашборда операторов (конфликт чтения и записи). | `db_instance`, `table`, `lock_type` |
| **Request Latency** (Длительность запроса) | Позволит понять, какие именно запросы тормозят дашборд операторов и API. | `endpoint`, `method`, `status_code`, `service` (MES, CRM, Shop) |
| **Error Rate** (Частота ошибок) | Поможет мгновенно узнать о сбоях в интеграциях (например, если Shop API не может достучаться до MES). | `service`, `error_type`, `endpoint` |
| **Queue Depth** (Глубина очереди RabbitMQ) | Критическая метрика. Показывает количество заказов, ожидающих расчета. Рост очереди — сигнал о перегрузке MES. | `queue_name` |
| **Order Throughput by Status** | Отслеживание количества заказов в каждом статусе. Позволит увидеть «пробки» (например, много заказов в SUBMITTED, но мало в PRICE_CALCULATED). | `status`, `client_type` (B2C/API) |
| **MES Calculation Duration** | Время, затраченное на расчет модели. Позволит подтвердить гипотезу о сложности моделей и планировать мощности. | `polygon_bracket` (до 10к, 10-100к, 100к+), `result` (success/fail) |
| **Database Connection Pool Saturation** | Поймем, не упираемся ли мы в лимит соединений при тяжелых расчетах. | `db_instance`, `state` (active/idle) |
| **CPU/RAM Utilization** | Базовая метрика для принятия решения об апгрейде EC2-инстансов. | `instance_id`, `service` |

## 4. План действий (Draft ТЗ)

1.  **Инфраструктура мониторинга:** Развернуть инстанс Prometheus для сбора метрик и Grafana для их визуализации в Yandex Cloud.
2.  **Инструментация приложений:**
    *   **Для Java (Shop, CRM):** Подключить библиотеку Micrometer для автоматического сбора метрик Spring Boot.
    *   **Для .NET (MES):** Использовать `prometheus-net` для экспорта данных о длительности расчетов и состоянии пула потоков.
3.  **Мониторинг очередей:** Настроить RabbitMQ Exporter для мониторинга состояния очередей и скорости обработки сообщений.
4.  **Мониторинг БД:** Подключить PostgreSQL Exporter для сбора данных о медленных запросах и загрузке CPU БД.
5.  **Настройка дашбордов:** Создать три уровня дашбордов:
    *   **Business:** Статусы заказов и время их жизни.
    *   **Service:** Latency и Errors по каждому API.
    *   **Infrastructure:** Нагрузка на серверы и БД.
6.  **Система оповещений:** Настроить Alertmanager для отправки уведомлений в Telegram/Slack при критических сбоях.

## 5. Дополнительно: Показатели насыщенности и пороги

Мы определили следующие критические точки, требующие немедленной реакции:

### Насыщенность очереди RabbitMQ

*   **Порог:** > 500 сообщений в очереди на расчет стоимости.
*   **Почему:** Это означает, что время ожидания для клиента начинает превышать 2 часа, что критично для B2B-партнеров.
*   **Действие:** Автоматическое уведомление дежурному инженеру + запуск скрипта на поднятие дополнительного инстанса MES-воркера.

### Нагрузка на CPU БД (MES db)

*   **Порог:** > 80% в течение 5 минут.
*   **Почему:** При таких значениях начинаются блокировки, и операторы не могут работать с дашбордом.
*   **Действие:** Завести тикет на оптимизацию самого тяжелого SQL-запроса (через `pg_stat_statements`) и рассмотреть переход на более мощный тариф Managed PostgreSQL.

### Длительность расчета (95-й перцентиль)

*   **Порог:** > 40 минут.
*   **Почему:** Превышение заявленного максимума (30 мин) ведет к репутационным потерям.
*   **Действие:** Письмо в саппорт и продакт-менеджеру для анализа конкретных 3D-файлов (возможно, нужно ограничить сложность моделей через API).
