# Архитектурное решение по кешированию

## 1. Мотивация

На текущий момент основной проблемой системы является низкая производительность MES-системы, что выражается в трех аспектах:

*   **Задержки интерфейса операторов:** Дашборд долго прогружается из-за высокой нагрузки на базу данных **MES db**, вызванной одновременно тяжелыми расчетами и частыми запросами на чтение списков заказов.
*   **Длительность бизнес-процесса:** Каждый заказ требует полного цикла расчета, даже если он типовой или состоит из повторяющихся элементов.
*   **Риск коллизий:** Операторы могут видеть неактуальные статусы заказов, что ведет к попыткам взять в работу уже занятый заказ.

### Цели внедрения кеширования:

*   Снижение нагрузки на **MES db** (разгрузка CPU и IOPS).
*   Мгновенная реакция дашборда операторов при повторных заходах или пагинации.
*   Ускорение процесса оформления заказа для пользователей за счет кеширования результатов расчетов типовых моделей/элементов.
*   **Обеспечение строгой консистентности:** Операторы должны видеть только актуальные статусы заказов.

### Что будем кешировать:

*   Списки заказов для операторов (активные очереди, с учетом фильтров и пагинации).
*   Текущие статусы заказов.
*   Справочные данные (цены на материалы, коэффициенты сложности).
*   Результаты расчетов стоимости для часто используемых конфигураций в конструкторе.

## 2. Предлагаемое решение

Мы будем использовать комбинированный подход. Основной упор делается на **Server-Side Caching** с использованием паттерна **Write-Through** для обеспечения актуальности критически важных данных.

### Типы кеширования

*   **Серверное кеширование (Distributed Cache):** Внедрение **Redis** между API-сервисами и базами данных. Это необходимо для синхронизации состояния между разными инстансами приложений в облаке.
*   **Клиентское кеширование (Browser/SPA):** Для статических ресурсов (Vue/React бандлы) и HTTP-кеширование API-ответов с использованием `ETag`. Используется ограниченно для динамических данных.

### Выбор паттерна: Write-Through 

Для работы с заказами и их статусами выбран паттерн **Write-Through**. В этом сценарии приложение обновляет данные сначала в кеше, а затем (синхронно) в базе данных. Чтение происходит преимущественно из кеша.

**Почему Write-Through:**

*   **Гарантия консистентности:** Данные в кеше никогда не бывают «протухшими» по сравнению с БД. При изменении статуса заказа обновление происходит мгновенно и там, и там.
*   **Быстрое чтение:** Поскольку данные обновляются при записи, операции чтения (дашборд оператора) всегда попадают в «прогретый» кеш (Cache Hit), не нагружая БД.
*   **Безопасность конкурентного доступа:** Снижается риск того, что два оператора увидят один и тот же заказ как «свободный», так как кеш является единым источником правды.

#### Почему другие не подходят:

*   **Cache-Aside:** Существует временной лаг между записью в БД и инвалидацией кеша. В высоконагруженной MES-системе это может привести к тому, что оператор увидит в списке заказ, который уже взят в работу другим сотрудником.
*   **Refresh-Ahead:** Трудно реализовать, так как мы не можем точно предсказать, какой именно фильтр применит оператор или какую модель создаст пользователь.

### Инвалидация кеша и отказоустойчивость

Мы будем использовать программную инвалидацию и **TTL (Time-To-Live)**.

*   **TTL (Time-To-Live):** Устанавливаем разумный TTL (например, 24 часа) для ключей заказов, чтобы кеш не забивался старыми данными.
*   **Failover:** Если запись в Redis не удалась, транзакция откатывается, и пользователю возвращается ошибка. Это гарантирует, что операторы не работают с рассинхронизированными данными.

## 3. Сравнительный анализ стратегий

| Критерий | Write-Through (Выбрано) | Cache-Aside (Отклонено) |
| :--- | :--- | :--- |
| **Скорость чтения** | Очень высокая (данные всегда в кеше). | Высокая, но возможны промахи (Cache Miss). |
| **Скорость записи** | Ниже (нужно писать в 2 места: Cache + DB). | Высокая (пишем только в БД, кеш инвалидируется асинхронно). |
| **Актуальность данных** | Максимальная (Кеш == БД). | Средняя (возможен лаг между записью и чтением). |
| **Нагрузка на БД** | Только на запись. Чтение идет из Redis. | Скачкообразная (при промахах кеша нагрузка падает на БД). |
| **Риск для MES** | Низкий (операторы видят правду). | Высокий (операторы могут видеть фантомные заказы). |







